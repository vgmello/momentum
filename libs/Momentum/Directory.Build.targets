<Project>
    <Target Name="GenerateLocalVersion" BeforeTargets="Build" Condition="'$(MSBuildProjectName)' == 'Momentum.Extensions.Abstractions' and !Exists('$(MSBuildThisFileDirectory)current-local-version.txt')">
        <PropertyGroup>
            <LocalVersionSuffix>$([System.DateTime]::UtcNow.ToString("yyyyMMdd-HHmmss"))</LocalVersionSuffix>
            <BaseVersion>$([System.IO.File]::ReadAllText('$(MSBuildThisFileDirectory)version.txt').Trim())</BaseVersion>
            <LocalVersion>$(BaseVersion)-local.$(LocalVersionSuffix)</LocalVersion>
            <LocalFeedAbsolutePath>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory).local/nuget'))</LocalFeedAbsolutePath>
        </PropertyGroup>
        <Message Text="Generating local version: $(LocalVersion)" Importance="high"/>
        <WriteLinesToFile File="$(MSBuildThisFileDirectory)current-local-version.txt" Lines="$(LocalVersion)" Overwrite="true"/>
        <WriteLinesToFile File="$(MSBuildThisFileDirectory)local-feed-path.txt" Lines="$(LocalFeedAbsolutePath)" Overwrite="true"/>
    </Target>

    <Target Name="CleanOldPackages" BeforeTargets="Build" Condition=" '$(IsPackable)' == 'true' and '$(Configuration)' == 'Debug' ">
        <ItemGroup>
            <OldPackagesToDelete Include="$(TargetDir)../*.*upkg"/>
            <OldPackagesToDelete Include="$(MSBuildThisFileDirectory).local/nuget/$(PackageId).*.nupkg"/>
        </ItemGroup>
        <Message Text="Cleaning up $(ProjectName) nupkg files. Target: $(TargetDir)" Importance="high"/>
        <Delete Files="@(OldPackagesToDelete)"/>
    </Target>

    <Target Name="UseConsistentLocalVersion" BeforeTargets="GenerateNuspec;Pack" Condition=" '$(IsPackable)' == 'true' and '$(Configuration)' == 'Debug' and Exists('$(MSBuildThisFileDirectory)current-local-version.txt') ">
        <PropertyGroup>
            <PackageVersion>$([System.IO.File]::ReadAllText('$(MSBuildThisFileDirectory)current-local-version.txt').Trim())</PackageVersion>
        </PropertyGroup>
        <Message Text="Using consistent local version: $(ProjectName)-$(PackageVersion)" Importance="high"/>
    </Target>

    <Target Name="PushToLocalFeed" AfterTargets="Pack" Condition=" '$(IsPackable)' == 'true' and '$(Configuration)' == 'Debug'">
        <MakeDir Directories="$(MSBuildThisFileDirectory).local/nuget" Condition="!Exists('$(MSBuildThisFileDirectory).local/nuget')"/>
        <Exec Command="dotnet nuget push &quot;$(PackageOutputPath)$(PackageId).$(PackageVersion).nupkg&quot; --source &quot;$(MSBuildThisFileDirectory).local/nuget&quot;"/>
    </Target>
</Project>
