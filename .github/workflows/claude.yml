name: Claude Code

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned, edited]
  pull_request_review:
    types: [submitted, edited]

env:
  DOTNET_VERSION: "10.0.x"

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

# Ensure only one workflow runs at a time per issue/PR
concurrency:
  group: claude-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Extract Context
        id: context
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_USER_LOGIN: ${{ github.event.issue.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER_LOGIN: ${{ github.event.comment.user.login }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_PATH: ${{ github.event.comment.path }}
          COMMENT_LINE: ${{ github.event.comment.line }}
          DIFF_HUNK: ${{ github.event.comment.diff_hunk }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEW_USER_LOGIN: ${{ github.event.review.user.login }}
        run: |
          # Initialize variables
          NUMBER=""
          TYPE=""
          BODY=""
          ACTOR=""

          case "$EVENT_NAME" in
            issues)
              echo "NUMBER=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="$ISSUE_NUMBER"
              TYPE="issue"
              BODY="$ISSUE_BODY"
              ACTOR="$ISSUE_USER_LOGIN"
              ;;
            issue_comment)
              echo "NUMBER=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="$ISSUE_NUMBER"
              TYPE="issue"
              BODY="$COMMENT_BODY"
              ACTOR="$COMMENT_USER_LOGIN"
              ;;
            pull_request_review_comment)
              echo "NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="$PR_NUMBER"
              TYPE="pr"
              echo "REF=$PR_HEAD_REF" >> $GITHUB_OUTPUT
              echo "COMMENT_ID=$COMMENT_ID" >> $GITHUB_OUTPUT
              echo "COMMENT_PATH=$COMMENT_PATH" >> $GITHUB_OUTPUT
              echo "COMMENT_LINE=$COMMENT_LINE" >> $GITHUB_OUTPUT
              {
                echo "COMMENT_DIFF_HUNK<<EOF"
                printf '%s\n' "$DIFF_HUNK" | head -n 5
                echo "EOF"
              } >> $GITHUB_OUTPUT
              BODY="$COMMENT_BODY"
              ACTOR="$COMMENT_USER_LOGIN"
              ;;
            pull_request_review)
              echo "NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="$PR_NUMBER"
              TYPE="pr"
              echo "REF=$PR_HEAD_REF" >> $GITHUB_OUTPUT
              BODY="$REVIEW_BODY"
              ACTOR="$REVIEW_USER_LOGIN"
              ;;
          esac

          echo "ACTOR=$ACTOR" >> $GITHUB_OUTPUT

          # Check if PR branch follows issue-{number} pattern
          # If so, use the issue number for Claude branch but keep PR number for comments
          CLAUDE_NUMBER="${NUMBER}"
          CLAUDE_TYPE="${TYPE}"
          if [ "$EVENT_NAME" == "pull_request_review_comment" ] || [ "$EVENT_NAME" == "pull_request_review" ]; then
            BRANCH_NAME="$PR_HEAD_REF"
            if [[ "$BRANCH_NAME" =~ ^issue-([0-9]+)$ ]]; then
              ISSUE_NUM="${BASH_REMATCH[1]}"
              echo "Detected issue branch pattern: $BRANCH_NAME -> issue #$ISSUE_NUM"
              CLAUDE_NUMBER="$ISSUE_NUM"
              CLAUDE_TYPE="issue"
            fi
          fi

          echo "CLAUDE_NUMBER=$CLAUDE_NUMBER" >> $GITHUB_OUTPUT
          echo "CLAUDE_TYPE=$CLAUDE_TYPE" >> $GITHUB_OUTPUT

          # Remove @claude mentions
          BODY=$(echo "$BODY" | sed 's/@claude//g')

          # Multi-line output
          {
            echo "BODY<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Check User Permissions
        id: permission_check
        env:
          INPUT_TOKEN: ${{ secrets.GH_PAT }}
          FALLBACK_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ steps.context.outputs.ACTOR }}
          CTX_TYPE: ${{ steps.context.outputs.TYPE }}
          CTX_NUMBER: ${{ steps.context.outputs.NUMBER }}
        run: |
          # Prefer an explicit PAT with repo + workflow scopes if provided; otherwise use the job token
          TOKEN="$INPUT_TOKEN"
          if [ -z "$TOKEN" ]; then
            TOKEN="$FALLBACK_TOKEN"
          fi

          # Get the user's permission level using GitHub API
          echo "Checking permissions for user: $ACTOR"

          # Query GitHub API for user's permission level
          PERMISSION_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/collaborators/$ACTOR/permission")

          PERMISSION=$(echo "$PERMISSION_RESPONSE" | jq -r '.permission // "none"')

          echo "User $ACTOR has permission level: $PERMISSION"

          # Check if user has write, maintain, or admin permission
          if [[ "$PERMISSION" == "write" || "$PERMISSION" == "maintain" || "$PERMISSION" == "admin" ]]; then
            echo "has_permission=true" >> $GITHUB_OUTPUT
            echo "✅ User $ACTOR has sufficient permissions ($PERMISSION)"
          else
            echo "has_permission=false" >> $GITHUB_OUTPUT
            echo "❌ User $ACTOR does not have sufficient permissions (current: $PERMISSION, required: write or above)"

            COMMENT_BODY="⚠️ **Permission Denied**

            Hi @$ACTOR, you need write access or higher to use the Claude workflow."

            if [ "$CTX_TYPE" == "issue" ]; then
              gh issue comment "$CTX_NUMBER" --body "$COMMENT_BODY"
            else
              gh pr comment "$CTX_NUMBER" --body "$COMMENT_BODY"
            fi
          fi

      - name: Run Claude Code
        if: steps.permission_check.outputs.has_permission == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          INPUT_TOKEN: ${{ secrets.GH_PAT }}
          FALLBACK_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          CTX_TYPE: ${{ steps.context.outputs.TYPE }}
          CTX_NUMBER: ${{ steps.context.outputs.NUMBER }}
          CTX_REF: ${{ steps.context.outputs.REF }}
          CTX_CLAUDE_TYPE: ${{ steps.context.outputs.CLAUDE_TYPE }}
          CTX_CLAUDE_NUMBER: ${{ steps.context.outputs.CLAUDE_NUMBER }}
          CTX_ACTOR: ${{ steps.context.outputs.ACTOR }}
          CTX_COMMENT_PATH: ${{ steps.context.outputs.COMMENT_PATH }}
          CTX_COMMENT_LINE: ${{ steps.context.outputs.COMMENT_LINE }}
          CTX_COMMENT_ID: ${{ steps.context.outputs.COMMENT_ID }}
          CTX_COMMENT_DIFF_HUNK: ${{ steps.context.outputs.COMMENT_DIFF_HUNK }}
          CTX_BODY: ${{ steps.context.outputs.BODY }}
        run: |
          # Prefer an explicit PAT with repo + workflow scopes if provided; otherwise use the job token
          TOKEN="$INPUT_TOKEN"
          if [ -z "$TOKEN" ]; then
            TOKEN="$FALLBACK_TOKEN"
          fi

          USER_PROMPT="You are working on $CTX_TYPE #$CTX_NUMBER in repository $REPO."

          # Add PR review comment context if available
          if [ -n "$CTX_COMMENT_PATH" ]; then
            USER_PROMPT="$USER_PROMPT

          This is a PR review comment on:
          - File: $CTX_COMMENT_PATH
          - Line: $CTX_COMMENT_LINE
          - Comment ID: $CTX_COMMENT_ID
          - Code context:
          \`\`\`
          $CTX_COMMENT_DIFF_HUNK
          \`\`\`"
          fi

          USER_PROMPT="$USER_PROMPT

          User request: $CTX_BODY"

          docker run --rm \
            -e CLAUDE_CODE_OAUTH_TOKEN="$CLAUDE_CODE_OAUTH_TOKEN" \
            -e GITHUB_TOKEN="$TOKEN" \
            -e GITHUB_REPOSITORY="$REPO" \
            -e GITHUB_REF="$CTX_REF" \
            -e CLAUDE_BRANCH_NAME="claude-${CTX_CLAUDE_TYPE}-${CTX_CLAUDE_NUMBER}" \
            -e USER_PROMPT="$USER_PROMPT" \
            -e GITHUB_ACTOR="$CTX_ACTOR" \
            -e ISSUE_TYPE="$CTX_TYPE" \
            -e ISSUE_NUMBER="$CTX_NUMBER" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            sdlc-claude:latest
